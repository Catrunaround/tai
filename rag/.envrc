#!/usr/bin/env bash

# TAI RAG Pipeline - direnv configuration with Poetry
# This file automatically activates the Poetry virtual environment when you cd into this directory

# Check if Poetry is available
if ! command -v poetry &> /dev/null; then
    echo "âŒ Poetry not found. Please install Poetry first:"
    echo "curl -sSL https://install.python-poetry.org | python3 -"
    return 1
fi

# Configure Poetry to use local .venv
poetry config virtualenvs.in-project true

# Check if .venv exists, if not create it with Poetry
if [[ ! -d ".venv" ]]; then
    echo "ğŸ”§ Creating Poetry virtual environment for RAG pipeline..."
    poetry install
    echo "âœ… Virtual environment created at $(pwd)/.venv"
fi

# Get the Poetry virtual environment path
VIRTUAL_ENV="$(poetry env info --path 2>/dev/null)"

if [[ -n "$VIRTUAL_ENV" && -d "$VIRTUAL_ENV" ]]; then
    # Activate the virtual environment
    export VIRTUAL_ENV
    export PATH="$VIRTUAL_ENV/bin:$PATH"
    unset PYTHON_HOME
    
    # Set environment variables for this project
    export PYTHONPATH="$(pwd):${PYTHONPATH}"
    export PROJECT_NAME="rag"
    export PROJECT_ROOT="$(pwd)"
    
    # Development environment variables
    export ENVIRONMENT="development"
    export DEBUG="true"
    
    # RAG-specific environment variables
    export RAG_CONFIG_PATH="$(pwd)/config"
    export RAG_DATA_PATH="$(pwd)/data"

    # PyTorch and CUDA library paths for torchaudio
    export PYTHONUNBUFFERED=1
    export LD_LIBRARY_PATH="/home/bot/anaconda3/envs/yk_env2/lib/python3.11/site-packages/torch/lib:/home/bot/anaconda3/envs/yk_env2/lib/python3.11/site-packages/nvidia/cudnn/lib:/home/bot/anaconda3/envs/yk_env2/lib/python3.11/site-packages/nvidia/cuda_runtime/lib:/home/bot/anaconda3/envs/yk_env2/lib/python3.11/site-packages/nvidia/cublas/lib:/home/bot/anaconda3/envs/yk_env2/lib/python3.11/site-packages/nvidia/cusolver/lib:/home/bot/anaconda3/envs/yk_env2/lib/python3.11/site-packages/nvidia/cusparse/lib:/home/bot/anaconda3/envs/yk_env2/lib/python3.11/site-packages/nvidia/cufft/lib:${LD_LIBRARY_PATH}"

    echo "ğŸš€ Activated RAG pipeline environment (Poetry)"
    echo "ğŸ“ Virtual env: $VIRTUAL_ENV"
    echo "ğŸ Python: $(python --version 2>&1)"
    echo "ğŸ“¦ Poetry: $(poetry --version 2>&1)"
else
    echo "âŒ Failed to activate Poetry environment. Run 'make install' to set up."
fi